<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>NetScope v33 - Diagnostic Suite</title>
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
    
    <style>
        :root {
            --bg: #050505; --panel: #101010; --text: #e0e0e0;
            --green: #00ff41; --cyan: #00f3ff; --orange: #ffab00; --red: #ff003c;
            --purple: #bf00ff; /* Color Gateway/WLAN */
        }

        body {
            background-color: var(--bg); color: var(--text);
            font-family: 'Segoe UI', Roboto, sans-serif;
            margin: 0; padding: 10px;
            display: flex; flex-direction: column; align-items: center;
            overflow-x: hidden;
        }

        /* HEADER */
        .tech-header { width: 100%; max-width: 1000px; border-bottom: 2px solid var(--cyan); padding-bottom: 15px; margin-bottom: 20px; display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; }
        h1 { margin: 0; font-size: 1.2rem; text-transform: uppercase; letter-spacing: 1px; }
        .isp-badge { background: #1a1a1a; color: var(--cyan); padding: 5px 10px; border: 1px solid var(--cyan); border-radius: 4px; font-size: 0.8rem; font-weight: bold; margin-top: 5px; }

        /* GATEWAY BAR */
        .gateway-bar {
            width: 100%; max-width: 1000px; background: #151515; border: 1px solid #333; border-radius: 8px;
            padding: 10px; margin-bottom: 15px; display: flex; gap: 10px; align-items: center; flex-wrap: wrap;
        }
        .gw-input { background: #000; border: 1px solid #444; color: var(--purple); padding: 8px; border-radius: 4px; font-family: monospace; flex: 1; min-width: 120px; }
        .chk-label { font-size: 0.8rem; display: flex; align-items: center; gap: 5px; cursor: pointer; color: #ccc; }

        /* DASHBOARD GRID */
        .dashboard { display: grid; grid-template-columns: 1fr; gap: 15px; width: 100%; max-width: 1000px; }
        @media (min-width: 768px) { .dashboard { grid-template-columns: 1fr 1fr; } .full-width { grid-column: 1 / -1; } }

        .card { background: var(--panel); border: 1px solid #333; border-radius: 8px; padding: 15px; position: relative; display: flex; flex-direction: column; justify-content: center; }
        .label { font-size: 0.7rem; color: #888; text-transform: uppercase; margin-bottom: 10px; display: block; font-weight: bold; }
        .big-num { font-size: 1.8rem; font-weight: bold; }
        .unit { font-size: 0.8rem; color: #666; display: block; margin-top: -5px;}

        /* DOMINANT BOX */
        .dominant-box {
            background: rgba(255,255,255,0.05); padding: 15px; border-radius: 6px;
            text-align: center; border: 1px solid #333; margin-bottom: 10px; transition: all 0.3s;
        }
        .dom-label { font-size: 0.8rem; letter-spacing: 2px; text-transform: uppercase; }
        .dom-val { font-size: 2rem; font-weight: bold; text-shadow: 0 0 15px currentColor; }

        /* GR√ÅFICAS */
        .chart-container { position: relative; height: 200px; width: 100%; overflow: hidden; }
        .chart-mini-container { position: relative; height: 120px; width: 100%; }

        /* CURVE GRID */
        .curve-grid { display: grid; grid-template-columns: 1fr; gap: 10px; }
        @media (min-width: 768px) { .curve-grid { grid-template-columns: 1fr 1fr; } }

        .mini-card { background: #0a0a0a; border: 1px solid #222; border-radius: 6px; padding: 10px; border-left: 3px solid #333; }
        .mini-head { font-size: 0.7rem; font-weight: bold; display: flex; justify-content: space-between; margin-bottom: 5px; color:#aaa; }

        /* BOTONES */
        .controls { display: flex; flex-direction: column; gap: 10px; width: 100%; max-width: 1000px; margin-top: 20px; padding-bottom: 20px; }
        button { padding: 15px; font-weight: bold; cursor: pointer; border-radius: 8px; text-transform: uppercase; border: none; width: 100%; }
        .btn-start { background: #222; color: var(--cyan); border: 1px solid var(--cyan); }
        .btn-report { background: var(--green); color: #000; }
        .btn-report:disabled { background: #333; color: #666; cursor: not-allowed; }
        .btn-options { background: transparent; color: #aaa; border: 1px dashed #555; margin-bottom: 10px; transition: all 0.3s; }
        .btn-options.active { background: #1a1a1a; color: white; border-color: white; }

        /* LEGENDAS */
        .legend-box { display: flex; gap: 15px; font-size: 0.75rem; margin-bottom: 5px; justify-content: flex-end; }
        .legend-item { display: flex; align-items: center; gap: 5px; }
        .dot { width: 8px; height: 8px; border-radius: 50%; }

        /* MODAL */
        .modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.95); display: none; justify-content: center; align-items: center; z-index: 1000; padding: 10px; box-sizing: border-box; }
        .report-paper { background: #0f0f0f; width: 100%; max-width: 800px; border: 1px solid #444; padding: 30px; max-height: 90vh; overflow-y: auto; }
        .print-mode { background: #fff !important; color: #000 !important; }
        .print-mode .card, .print-mode .mini-card { background: #fff !important; border: 1px solid #ccc !important; }
        .print-mode h2, .print-mode b { color: #000 !important; }
    </style>
</head>
<body>

    <div class="modal-overlay" id="reportModal">
        <div class="report-paper">
            <div id="printableArea">
                <div style="border-bottom:2px solid #333; margin-bottom:15px; padding-bottom:10px;">
                    <h2 style="margin:0; color:var(--cyan);">AUDITOR√çA T√âCNICA DE RED</h2>
                    <div style="display:flex; justify-content:space-between; font-size:0.8rem; color:#888;">
                        <span id="repIspFull">ISP: --</span>
                        <span id="repDate">--</span>
                    </div>
                </div>

                <div style="background:#151515; padding:15px; border-radius:6px; margin-bottom:20px; border-left:4px solid var(--green);">
                    <span class="label">ESTIMACI√ìN DE MODULACI√ìN EFECTIVA</span>
                    <div id="repDomVal" style="font-size:1.8rem; font-weight:bold; color:white;">--</div>
                </div>

                <div class="label" style="border-bottom:1px solid #333; margin-bottom:10px;">M√âTRICAS COMPARATIVAS (WAN vs WLAN)</div>
                <div style="display:grid; grid-template-columns: 1fr 1fr; gap:10px; margin-bottom:20px;">
                    <div style="border:1px solid #333; padding:10px; border-radius:5px;">
                        <div style="color:var(--cyan); font-weight:bold; margin-bottom:5px;">SEGMENTO INTERNET (WAN)</div>
                        <div style="display:flex; justify-content:space-between;">
                            <span>Latencia:</span> <b id="repWanPing" style="color:white">0 ms</b>
                        </div>
                        <div style="display:flex; justify-content:space-between;">
                            <span>SNR Estimado:</span> <b id="repWanSnr" style="color:white">0 dB</b>
                        </div>
                    </div>
                    <div style="border:1px solid #333; padding:10px; border-radius:5px;">
                        <div style="color:var(--purple); font-weight:bold; margin-bottom:5px;">SEGMENTO LOCAL (WLAN)</div>
                        <div style="display:flex; justify-content:space-between;">
                            <span>Latencia:</span> <b id="repLanPing" style="color:white">0 ms</b>
                        </div>
                        <div style="display:flex; justify-content:space-between;">
                            <span>SNR Estimado:</span> <b id="repLanSnr" style="color:white">0 dB</b>
                        </div>
                    </div>
                </div>

                <div class="label">MONITOR DE ESTABILIDAD</div>
                <div style="background:#fff; padding:10px; border-radius:6px; margin-bottom:20px;">
                    <canvas id="repLineCanvas" style="height:150px !important;"></canvas>
                </div>

                <div class="label">DENSIDAD DE PROBABILIDAD</div>
                <div style="background:#fff; padding:10px; border-radius:6px; margin-bottom:20px;">
                    <canvas id="repCurveCanvas" style="height:150px !important;"></canvas>
                </div>

                <div class="label">DICTAMEN T√âCNICO DETALLADO</div>
                <div id="repConclusion" style="background:rgba(0,243,255,0.05); padding:10px; border-left:4px solid var(--cyan); font-size:0.85rem; color:#ddd; margin-bottom:20px; line-height:1.5;">...</div>

                <div class="label" style="color:var(--orange);">RECOMENDACIONES DE CORRECCI√ìN</div>
                <div id="repRecommendations" style="border:1px dashed #555; padding:15px; border-radius:5px; font-size:0.85rem; color:#ccc;">
                    <ul id="recList" style="margin:0; padding-left:20px;"></ul>
                </div>

            </div>
            <div class="controls">
                <button onclick="downloadPDF()" class="btn-report">Descargar PDF</button>
                <button onclick="closeReport()" class="btn-start" style="background:#333; border:none; color:white;">Cerrar</button>
            </div>
        </div>
    </div>

    <div class="tech-header">
        <div>
            <h1>NetScope <span style="color:var(--cyan)">v33 Diagnostic Suite</span></h1>
            <div id="headerISP" class="isp-badge">Detectando ISP...</div>
        </div>
        <div class="badge" id="liveStatus">IDLE</div>
    </div>

    <div class="gateway-bar">
        <label class="chk-label">
            <input type="checkbox" id="chkGateway" onchange="toggleGateway()" checked> 
            Analizar WLAN (Gateway)
        </label>
        <input type="text" id="gatewayIp" class="gw-input" value="192.168.1.254" placeholder="IP Router">
    </div>

    <div class="dashboard">
        <div class="card full-width">
            <span class="label">MODULACI√ìN EFECTIVA (DEDUCIDA)</span>
            <div class="dominant-box" id="domBox">
                <div class="dom-label">ESTIMACI√ìN BASADA EN LATENCIA</div>
                <div class="dom-val" id="domVal">--</div>
                <div style="font-size:0.8rem; margin-top:5px; color:#aaa;" id="domSub">
                    Calibrado para dispositivos m√≥viles
                </div>
            </div>
        </div>

        <div class="card">
            <span class="label">Latencia (Ping)</span>
            <div style="display:flex; justify-content:space-between; margin-bottom:10px;">
                <div><div class="big-num" id="wanVal" style="color:var(--cyan)">0</div><div class="unit">ms (WAN)</div></div>
                <div style="text-align:right;"><div class="big-num" id="gwVal" style="color:var(--purple)">0</div><div class="unit">ms (WLAN)</div></div>
            </div>
        </div>

        <div class="card">
            <span class="label">SNR Estimado (Estabilidad)</span>
            <div style="display:flex; justify-content:space-between; margin-bottom:10px;">
                <div><div class="big-num" id="wanSnr" style="color:var(--cyan)">0</div><div class="unit">dB (WAN)</div></div>
                <div style="text-align:right;"><div class="big-num" id="gwSnr" style="color:var(--purple)">0</div><div class="unit">dB (WLAN)</div></div>
            </div>
        </div>

        <div class="card full-width">
            <div style="display:flex; justify-content:space-between; align-items:center;">
                <span class="label">Monitor Comparativo</span>
                <div class="legend-box">
                    <div class="legend-item"><div class="dot" id="legendWan" style="background:var(--cyan)"></div> WAN</div>
                    <div class="legend-item"><div class="dot" style="background:var(--purple)"></div> WLAN</div>
                </div>
            </div>
            <div class="chart-container">
                <canvas id="lineChart"></canvas>
            </div>
        </div>

        <div class="full-width">
            <button onclick="toggleDensity()" class="btn-options" id="btnDensity">‚ñº MOSTRAR DENSIDAD COMPARATIVA</button>
        </div>

        <div class="full-width" id="densityPanel" style="display:none;">
            <div class="curve-grid">
                <div class="mini-card" style="border-left-color:var(--green)">
                    <div class="mini-head" style="color:var(--green)">256-QAM (0-60ms) <span id="pct1">0%</span></div>
                    <div class="chart-mini-container"><canvas id="chart1"></canvas></div>
                </div>
                <div class="mini-card" style="border-left-color:var(--cyan)">
                    <div class="mini-head" style="color:var(--cyan)">64-QAM (60-100ms) <span id="pct2">0%</span></div>
                    <div class="chart-mini-container"><canvas id="chart2"></canvas></div>
                </div>
                <div class="mini-card" style="border-left-color:var(--orange)">
                    <div class="mini-head" style="color:var(--orange)">16-QAM (100-180ms) <span id="pct3">0%</span></div>
                    <div class="chart-mini-container"><canvas id="chart3"></canvas></div>
                </div>
                <div class="mini-card" style="border-left-color:var(--red)">
                    <div class="mini-head" style="color:var(--red)">QPSK (>180ms) <span id="pct4">0%</span></div>
                    <div class="chart-mini-container"><canvas id="chart4"></canvas></div>
                </div>
            </div>
        </div>
    </div>

    <div class="controls">
        <button onclick="startTest()" class="btn-start" id="btnStart">‚ñ∂ INICIAR COMPARATIVA</button>
        <button onclick="generateReport()" class="btn-report" id="btnReport" disabled>üìã GENERAR REPORTE</button>
    </div>

    <script>
        let running = false;
        let timer;
        let sessionWan = [];
        let sessionGw = [];
        let sessionWanSnr = [];
        let sessionGwSnr = [];
        let currentISP = "Desconocido";
        let reportChartInstance = null;
        let reportLineInstance = null;

        // --- FETCH ISP ---
        fetch('https://ipapi.co/json/')
            .then(r => r.json())
            .then(d => {
                currentISP = `${d.org} (${d.city})`;
                document.getElementById('headerISP').innerText = currentISP;
            })
            .catch(() => { document.getElementById('headerISP').innerText = "ISP Desconocido"; });

        function toggleDensity() {
            const el = document.getElementById('densityPanel');
            const btn = document.getElementById('btnDensity');
            if(el.style.display === 'none') {
                el.style.display = 'block'; btn.classList.add('active'); btn.innerText = "‚ñ≤ OCULTAR";
            } else {
                el.style.display = 'none'; btn.classList.remove('active'); btn.innerText = "‚ñº MOSTRAR DENSIDAD COMPARATIVA";
            }
        }

        function toggleGateway() {
            const chk = document.getElementById('chkGateway');
            document.getElementById('gatewayIp').disabled = !chk.checked;
        }

        const ctxLine = document.getElementById('lineChart').getContext('2d');
        const lineChart = new Chart(ctxLine, {
            type: 'line',
            data: {
                labels: Array(30).fill(''),
                datasets: [
                    { label: 'WAN (Internet)', data: Array(30).fill(null), borderColor: '#00f3ff', borderWidth: 2, tension: 0.3, pointRadius: 0 },
                    { label: 'WLAN (Local)', data: Array(30).fill(null), borderColor: '#bf00ff', borderWidth: 2, borderDash: [5, 5], tension: 0.3, pointRadius: 0 }
                ]
            },
            options: { responsive: true, maintainAspectRatio: false, animation: false, scales: { x: { display: false }, y: { grid: { color: '#222' }, suggestedMax: 100 } }, plugins: { legend: { display: false } } }
        });

        const RANGES = [
            { id: 'chart1', min: 0, max: 60, color: '#00ff41', name: '256-QAM' },
            { id: 'chart2', min: 60, max: 100, color: '#00f3ff', name: '64-QAM' },
            { id: 'chart3', min: 100, max: 180, color: '#ffab00', name: '16-QAM' },
            { id: 'chart4', min: 180, max: 400, color: '#ff003c', name: 'QPSK' }
        ];

        const densityCharts = RANGES.map(r => {
            const ctx = document.getElementById(r.id).getContext('2d');
            const step = (r.max - r.min) / 14;
            const labels = Array.from({length: 15}, (_, i) => Math.round(r.min + (i * step)));
            
            return new Chart(ctx, {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: [
                        { data: new Array(15).fill(0), borderColor: r.color, backgroundColor: r.color + '40', borderWidth: 2, fill: true, tension: 0.5, pointRadius: 0 },
                        { data: new Array(15).fill(0), borderColor: '#bf00ff', borderWidth: 2, borderDash: [3,3], fill: false, tension: 0.5, pointRadius: 0 }
                    ]
                },
                options: { responsive: true, maintainAspectRatio: false, animation: false, scales: { x: { display: true, ticks: {color:'#666', font:{size:8}}, grid:{display:false} }, y: { display: false } }, plugins: { legend: { display: false } } }
            });
        });

        // --- PING GATEWAY (IMAGE) ---
        function pingLocalGateway(ip) {
            return new Promise((resolve) => {
                const start = performance.now();
                const img = new Image();
                let finished = false;
                const timer = setTimeout(() => { if(!finished) { finished = true; resolve(null); } }, 1500);
                const done = () => { if(!finished) { finished = true; clearTimeout(timer); resolve(performance.now() - start); } };
                img.onload = done; img.onerror = done;
                try { img.src = `http://${ip}/favicon.ico?r=${Math.random()}`; } catch(e) { resolve(null); }
            });
        }

        // --- CALCULADORA DE SNR ESTIMADO ---
        function calculateSNR(ping, jitter) {
            // Algoritmo emp√≠rico para estimar calidad de enlace
            let baseSnr = 50; 
            let penalty = (jitter * 2) + (ping * 0.1);
            if (ping > 100) penalty += 10;
            return Math.max(0, Math.min(60, baseSnr - penalty));
        }

        // --- MATH ---
        function updateDensityCurves(wanData, gwData) {
            let counts = [0, 0, 0, 0];
            let wanDensities = [new Array(15).fill(0), new Array(15).fill(0), new Array(15).fill(0), new Array(15).fill(0)];
            let gwDensities = [new Array(15).fill(0), new Array(15).fill(0), new Array(15).fill(0), new Array(15).fill(0)];

            const processData = (sourceData, densityArray, countArray) => {
                sourceData.forEach(ping => {
                    if (ping === null) return;
                    let idx = -1;
                    if (ping <= 60) idx = 0; else if (ping <= 100) idx = 1; else if (ping <= 180) idx = 2; else idx = 3;
                    
                    if (idx !== -1) {
                        if(countArray) countArray[idx]++;
                        const r = RANGES[idx];
                        const norm = (ping - r.min) / (r.max - r.min);
                        if (norm >= 0 && norm <= 1) {
                            const cIdx = Math.floor(norm * 14);
                            densityArray[idx][cIdx] += 1;
                            if(cIdx>0) densityArray[idx][cIdx-1]+=0.5;
                            if(cIdx<14) densityArray[idx][cIdx+1]+=0.5;
                        }
                    }
                });
            };

            processData(wanData, wanDensities, counts);
            processData(gwData, gwDensities, null);

            densityCharts.forEach((chart, i) => {
                chart.data.datasets[0].data = wanDensities[i]; // WAN
                chart.data.datasets[1].data = gwDensities[i];  // LAN
                chart.update();
                const total = wanData.length || 1;
                document.getElementById(`pct${i+1}`).innerText = ((counts[i] / total) * 100).toFixed(0) + "%";
            });
            return counts;
        }

        async function loop() {
            if (!running) return;
            const start = performance.now();
            try { await fetch('https://1.1.1.1/cdn-cgi/trace?z=' + Math.random(), { mode: 'no-cors', cache: 'no-store' }); } catch (e) {}
            const wanPing = performance.now() - start;
            sessionWan.push(wanPing);

            // Jitter & SNR WAN
            const jitterWan = sessionWan.length > 1 ? Math.abs(wanPing - sessionWan[sessionWan.length-2]) : 0;
            const snrWan = calculateSNR(wanPing, jitterWan);
            sessionWanSnr.push(snrWan);

            let gwPing = null;
            let snrGw = 0;
            if (document.getElementById('chkGateway').checked) {
                const ip = document.getElementById('gatewayIp').value;
                gwPing = await pingLocalGateway(ip);
                if(gwPing) {
                    sessionGw.push(gwPing);
                    const jitterGw = sessionGw.length > 1 ? Math.abs(gwPing - sessionGw[sessionGw.length-2]) : 0;
                    snrGw = calculateSNR(gwPing, jitterGw);
                    sessionGwSnr.push(snrGw);
                }
            }

            // Update Metrics UI
            document.getElementById('wanVal').innerText = wanPing.toFixed(0);
            document.getElementById('gwVal').innerText = gwPing ? gwPing.toFixed(0) : "--";
            
            document.getElementById('wanSnr').innerText = snrWan.toFixed(1);
            document.getElementById('wanSnr').style.color = snrWan > 30 ? "var(--green)" : "var(--red)";
            
            document.getElementById('gwSnr').innerText = snrGw > 0 ? snrGw.toFixed(1) : "--";
            document.getElementById('gwSnr').style.color = snrGw > 35 ? "var(--purple)" : "var(--orange)";

            const counts = updateDensityCurves(sessionWan, sessionGw);

            let maxIdx = 0;
            for(let i=1; i<4; i++) { if(counts[i] > counts[maxIdx]) maxIdx = i; }
            const winner = RANGES[maxIdx];

            lineChart.data.datasets[0].borderColor = winner.color;
            document.getElementById('legendWan').style.backgroundColor = winner.color;

            lineChart.data.datasets[0].data.shift();
            lineChart.data.datasets[0].data.push(wanPing);
            lineChart.data.datasets[1].data.shift();
            lineChart.data.datasets[1].data.push(gwPing);
            lineChart.update();

            const confidence = ((counts[maxIdx] / (sessionWan.length || 1)) * 100).toFixed(0);
            const domEl = document.getElementById('domVal');
            const boxEl = document.getElementById('domBox');
            domEl.innerText = winner.name;
            domEl.style.color = winner.color;
            boxEl.style.borderColor = winner.color;
            boxEl.style.boxShadow = `0 0 15px ${winner.color}20`;
            document.getElementById('domSub').innerText = `Estabilidad del ${confidence}% (Calibraci√≥n M√≥vil)`;
        }

        function generateReport() {
            stopTest();
            if(sessionWan.length === 0) return;

            // Promedios
            const avgWan = sessionWan.reduce((a,b)=>a+b,0)/sessionWan.length;
            const avgGw = sessionGw.length > 0 ? sessionGw.reduce((a,b)=>a+b,0)/sessionGw.length : 0;
            const avgSnrWan = sessionWanSnr.reduce((a,b)=>a+b,0)/sessionWanSnr.length;
            const avgSnrGw = sessionGwSnr.length > 0 ? sessionGwSnr.reduce((a,b)=>a+b,0)/sessionGwSnr.length : 0;

            const counts = updateDensityCurves(sessionWan, sessionGw);
            let maxIdx = 0;
            for(let i=1; i<4; i++) { if(counts[i] > counts[maxIdx]) maxIdx = i; }
            const winner = RANGES[maxIdx];

            document.getElementById('repIspFull').innerText = currentISP;
            document.getElementById('repDate').innerText = new Date().toLocaleDateString();
            
            // Valores Reporte
            document.getElementById('repWanPing').innerText = avgWan.toFixed(0) + " ms";
            document.getElementById('repLanPing').innerText = avgGw > 0 ? avgGw.toFixed(0) + " ms" : "N/A";
            document.getElementById('repWanSnr').innerText = avgSnrWan.toFixed(1) + " dB";
            document.getElementById('repLanSnr').innerText = avgGw > 0 ? avgSnrGw.toFixed(1) + " dB" : "N/A";
            
            document.getElementById('repDomVal').innerText = winner.name;
            document.getElementById('repDomVal').style.color = winner.color;

            // --- GENERADOR DE DICTAMEN Y RECOMENDACIONES ---
            let conc = "";
            let recommendations = [];
            let diff = avgGw > 0 ? (avgWan - avgGw) : 0;
            
            // 1. An√°lisis Local
            if (avgGw > 60) {
                conc += "<strong>PROBLEMA CR√çTICO EN WLAN.</strong> La latencia interna al Gateway es excesiva. Esto indica interferencia severa en el canal Wi-Fi o saturaci√≥n del router. ";
                recommendations.push("Cambiar el canal Wi-Fi (1, 6 u 11 en 2.4GHz).");
                recommendations.push("Acercarse al Router o usar banda de 5GHz.");
                recommendations.push("Reiniciar el Router para liberar memoria.");
            } else if (avgGw > 20) {
                conc += "<strong>DEGRADACI√ìN LEVE WLAN.</strong> La red local introduce un retardo perceptible pero funcional. ";
                recommendations.push("Verificar si hay descargas en segundo plano en la red local.");
            } else if (avgGw > 0) {
                conc += "<strong>RED LOCAL (WLAN) √ìPTIMA.</strong> El enlace al router es s√≥lido. ";
            } else {
                conc += "<strong>WLAN NO ANALIZADA.</strong> No se pudo auditar el tramo local. ";
                recommendations.push("Habilitar 'Comparar WLAN' e ingresar IP del Gateway para un diagn√≥stico completo.");
            }

            // 2. An√°lisis WAN
            if (diff > 120) {
                conc += "<br><br><strong>FALLO DEL PROVEEDOR (ISP).</strong> A pesar de tener una red local funcional, la salida a Internet presenta alta latencia. El problema reside en la infraestructura externa. ";
                recommendations.push("Contactar a soporte t√©cnico del ISP y reportar latencia alta.");
                recommendations.push("Verificar el estado del cableado de acometida (fibra/coaxial).");
            } else if (avgSnrWan < 20) {
                conc += "<br><br><strong>INESTABILIDAD WAN (RUIDO).</strong> El SNR bajo indica fluctuaciones (Jitter) altas en la conexi√≥n a internet. ";
                recommendations.push("Revisar conexiones f√≠sicas sulfatadas o da√±adas.");
            }

            // 3. Conclusi√≥n Modulaci√≥n
            if (winner.name === '256-QAM') conc += "<br><br><strong>CLASIFICACI√ìN: EXCELENTE.</strong> Rendimiento general de alto nivel.";
            else if (winner.name === 'QPSK') {
                conc += "<br><br><strong>CLASIFICACI√ìN: CR√çTICA.</strong> La conexi√≥n es inoperable para tiempo real.";
                recommendations.push("Si usa datos m√≥viles, busque una zona con mejor cobertura.");
            }

            document.getElementById('repConclusion').innerHTML = conc;
            document.getElementById('repConclusion').style.borderLeftColor = winner.color;

            // Renderizar Recomendaciones
            const recList = document.getElementById('recList');
            recList.innerHTML = "";
            if (recommendations.length === 0) {
                recList.innerHTML = "<li style='color:var(--green)'>No se requieren acciones correctivas. Sistema √≥ptimo.</li>";
            } else {
                recommendations.forEach(rec => {
                    const li = document.createElement('li');
                    li.innerText = rec;
                    li.style.marginBottom = "5px";
                    recList.appendChild(li);
                });
            }

            // Clones para Reporte
            if(reportLineInstance) reportLineInstance.destroy();
            const ctxL = document.getElementById('repLineCanvas').getContext('2d');
            reportLineInstance = new Chart(ctxL, {
                type: 'line', data: { labels: Array(sessionWan.length).fill(''), datasets: [
                    { data: sessionWan, borderColor: winner.color, borderWidth: 1, pointRadius: 0 },
                    { data: sessionGw, borderColor: '#bf00ff', borderWidth: 1, borderDash:[2,2], pointRadius: 0 }
                ]},
                options: { responsive: true, maintainAspectRatio: false, animation: false, scales:{x:{display:false}}, plugins:{legend:{display:false}} }
            });

            if(reportChartInstance) reportChartInstance.destroy();
            const ctxC = document.getElementById('repCurveCanvas').getContext('2d');
            reportChartInstance = new Chart(ctxC, {
                type: 'bar', data: { labels: ["256-QAM","64-QAM","16-QAM","QPSK"], datasets: [{ data: counts, backgroundColor: [RANGES[0].color, RANGES[1].color, RANGES[2].color, RANGES[3].color], borderRadius: 4 }] },
                options: { responsive: true, maintainAspectRatio: false, animation: false, scales:{y:{display:false}}, plugins:{legend:{display:false}} }
            });

            document.getElementById('reportModal').style.display = 'flex';
        }

        function downloadPDF() {
            const el = document.getElementById('printableArea');
            el.classList.add('print-mode');
            const opt = { margin: 5, filename: `NetScope_v33.pdf`, image: { type: 'jpeg', quality: 0.98 }, html2canvas: { scale: 2 }, jsPDF: { unit: 'mm', format: 'a4', orientation: 'portrait' } };
            html2pdf().set(opt).from(el).save().then(() => el.classList.remove('print-mode'));
        }

        function startTest() {
            if(running) return;
            running = true; sessionWan = []; sessionGw = []; sessionWanSnr = []; sessionGwSnr = [];
            timer = setInterval(loop, 1000);
            document.getElementById('btnStart').disabled = true; document.getElementById('btnReport').disabled = false;
        }
        function closeReport() { document.getElementById('reportModal').style.display = 'none'; }
        function stopTest() { running = false; clearInterval(timer); document.getElementById('btnStart').disabled = false; }
    </script>
</body>
</html>









